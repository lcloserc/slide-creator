generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model GenerationPrompt {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   @unique
  content   String
  folder    String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("generation_prompts")
}

model SystemPrompt {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   @unique
  content   String
  folder    String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_prompts")
}

model OutputFormat {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   @unique
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("output_formats")
}

model Project {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  folders      Folder[]
  resources    Resource[]
  pipelineRuns PipelineRun[]

  @@map("projects")
}

model Folder {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  parentId  String?  @map("parent_id") @db.Uuid
  name      String
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")

  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent       Folder?       @relation("FolderTree", fields: [parentId], references: [id], onDelete: Cascade)
  children     Folder[]      @relation("FolderTree")
  resources    Resource[]
  pipelineRuns PipelineRun[]

  @@map("folders")
}

model Resource {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId    String   @map("project_id") @db.Uuid
  folderId     String?  @map("folder_id") @db.Uuid
  name         String
  resourceType String   @map("resource_type")
  contentText  String?  @map("content_text")
  contentJson  Json?    @map("content_json")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  folder       Folder?       @relation(fields: [folderId], references: [id], onDelete: SetNull)
  pipelineRuns PipelineRun[] @relation("FinalResource")

  @@map("resources")
}

model GenerationPipeline {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String   @unique
  pipelineData Json     @map("pipeline_data")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  runs PipelineRun[]

  @@map("generation_pipelines")
}

model PipelineRun {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  pipelineId        String    @map("pipeline_id") @db.Uuid
  projectId         String    @map("project_id") @db.Uuid
  status            String    @default("running")
  currentStep       Int       @default(0) @map("current_step")
  totalSteps        Int       @map("total_steps")
  stepResults       Json      @default("[]") @map("step_results")
  outputFolderId    String?   @map("output_folder_id") @db.Uuid
  sourceResourceIds Json      @default("[]") @map("source_resource_ids")
  finalResourceId   String?   @map("final_resource_id") @db.Uuid
  error             String?
  startedAt         DateTime  @default(now()) @map("started_at")
  completedAt       DateTime? @map("completed_at")

  pipeline      GenerationPipeline @relation(fields: [pipelineId], references: [id])
  project       Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  outputFolder  Folder?            @relation(fields: [outputFolderId], references: [id], onDelete: SetNull)
  finalResource Resource?          @relation("FinalResource", fields: [finalResourceId], references: [id], onDelete: SetNull)

  @@map("pipeline_runs")
}
